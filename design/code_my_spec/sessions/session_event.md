# Sessions.SessionEvent Schema

## Purpose

Represents a single event capturing real-time activity during Claude Code session execution. Events are stored in a separate `session_events` table as an append-only log, providing visibility into agent operations between command issuance and result submission.

## Fields

| Field | Type | Required | Description | Constraints |
|-------|------|----------|-------------|-------------|
| id | bigserial | Yes (auto) | Primary key | Auto-generated sequential ID |
| session_id | integer | Yes | Foreign key to sessions table | References sessions.id |
| event_type | Ecto.Enum | Yes | Category of event | See Event Types below |
| data | map (JSONB) | Yes | Event-specific payload | Not validated, accepts any map |
| metadata | map (JSONB) | No | Optional context | Client version, user agent, etc. |
| sent_at | utc_datetime | Yes | When client sent the record | None |
| inserted_at | utc_datetime | Yes (auto) | When record was created | Auto-generated by Ecto |
| updated_at | utc_datetime | Yes (auto) | When record was updated | Auto-generated by Ecto |

## Event Types

Event types are defined as an Ecto.Enum with the following values:

### Conversation Events
- `:conversation_started` - Claude conversation begins
- `:conversation_message_sent` - User message sent to Claude
- `:conversation_message_received` - Claude responds
- `:conversation_ended` - Conversation completes

### Tool Events
- `:tool_called` - Claude invokes a tool (Read, Write, Edit, Bash, etc.)
- `:tool_result` - Tool execution completes

### File Events
- `:file_created` - New file created by agent
- `:file_modified` - Existing file changed by agent
- `:file_deleted` - File removed by agent

### Command Events
- `:command_started` - Shell command begins execution
- `:command_output` - Command produces stdout/stderr
- `:command_completed` - Command exits with code

### Hook Events
- `:hook_triggered` - User hook begins execution
- `:hook_completed` - Hook finishes

### State Events
- `:session_status_changed` - Session transitions between statuses
- `:session_paused` - Session temporarily stopped
- `:session_resumed` - Session continues after pause

### Error Events
- `:error_occurred` - Any error during session execution

## Associations

### belongs_to
- **session** - Parent Session record (foreign key: session_id, required)

## Validation Rules

### Required Fields
- `session_id` - Must reference existing session
- `event_type` - Must be one of the enum values above
- `sent_at` - Must be valid UTC datetime
- `data` - Must be present (can be empty map)

### Data Field Validation
**Important**: The `data` field accepts ANY map structure. The schema does NOT validate the contents of `data` based on event_type. This is intentional - we want flexibility to evolve event payloads without schema migrations.

### Optional Fields
- `interaction_id` - May be nil for events not tied to specific interactions
- `metadata` - May be nil if no additional context needed

## Database Schema

### Table Name
`session_events`

### Indexes
- Primary key on `id` (auto)
- Foreign key index on `session_id`
- Composite index on `(session_id, sent_at)` for efficient ordered queries
- Optional GIN index on `data` JSONB field (can be added later if needed)

### Foreign Key Constraints
- `session_id` references `sessions(id)` with ON DELETE CASCADE
  - When a session is deleted, all its events are automatically deleted

## Changesets

### changeset/2

Standard changeset for creating and updating events.

**Parameters**:
- `event` - SessionEvent struct (new or existing)
- `attrs` - Map of attributes

**Validations**:
- Casts: session_id, interaction_id, event_type, sent_at, data, metadata
- Requires: session_id, event_type, sent_at, data
- Validates event_type is in enum
- Foreign key constraint on session_id

**Transformations**:
- Auto-generates `inserted_at` timestamp
- No transformations on data field (accepts as-is)

## Usage Notes

### Append-Only
Events should be treated as immutable. Once inserted, they should not be updated. If correction is needed, insert a new corrective event.

### Client-Provided Timestamp
The `sent_at` field is provided by the client (when the event occurred), not the server. This allows accurate temporal ordering even if network latency delays event submission. The `inserted_at` field tracks when the server received the event.

### Timestamp Ordering
Events are ordered by `sent_at` field, not `inserted_at`. Clients must ensure timestamps are monotonically increasing within a session, or at least within an interaction.

### Batch Insertion
Events should be inserted in batches using `Repo.insert_all/3` for performance. The EventHandler coordinates batch insertion with session updates in a single transaction.

### Scope Validation
While SessionEvent schema doesn't directly track account_id/user_id, scope validation happens indirectly through the parent Session relationship. The EventHandler validates scope before allowing event insertion.

## Performance Considerations

### Index Usage
The composite index on `(session_id, sent_at)` is critical for query performance. All event queries should filter by session_id first, then order by sent_at.

### JSONB Storage
The `data` and `metadata` fields use JSONB for flexible storage. JSONB is compressed and indexed efficiently by PostgreSQL. Avoid storing large payloads (>1MB) in these fields - use external storage if needed.

### Pagination
Always use pagination (limit/offset) when querying events for large sessions. A single session can accumulate thousands of events.