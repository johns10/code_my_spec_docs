# Finalize

## Purpose

Completes the context review session by executing git add for the review file and marking the session status as complete. This step stages the review summary document generated by Claude during the ExecuteReview step, making it ready for commit and integration into the project documentation.

## Public API

```elixir
# StepBehaviour callbacks
@spec get_command(scope :: Scope.t(), session :: Session.t(), opts :: keyword()) ::
        {:ok, Command.t()} | {:error, String.t()}

@spec handle_result(scope :: Scope.t(), session :: Session.t(), result :: Result.t(), opts :: keyword()) ::
        {:ok, session_updates :: map(), updated_result :: Result.t()} | {:error, String.t()}
```

## Execution Flow

### get_command/3

1. **Validate Session Component**: Verify the session has an associated context component
   - Return `{:error, "Context component not found in session"}` if component is missing

2. **Extract Context Component**: Retrieve the context component from the session
   - The component represents the Phoenix context that was reviewed

3. **Get Context Design File Path**: Use `CodeMySpec.Utils.component_files/2` to determine the context design file path
   - Input: context component and project from session
   - Output: map containing `:design_file` key with path like `docs/design/code_my_spec/sessions.md`

4. **Calculate Review File Path**: Derive the review output file path from context design path
   - Extract base directory from context design file path (e.g., `docs/design/code_my_spec/sessions.md` → `docs/design/code_my_spec/sessions`)
   - Append `design_review.md` to create review file path: `docs/design/code_my_spec/sessions/design_review.md`

5. **Strip docs/ Prefix**: Remove the `docs/` prefix from the review file path for git command
   - Git command will be executed with `-C docs` flag, so path should be relative to docs directory
   - Example: `docs/design/code_my_spec/sessions/design_review.md` → `design/code_my_spec/sessions/design_review.md`

6. **Build Git Command**: Construct shell command to stage the review file
   - Command format: `git -C docs add <review_file_path>`
   - Example: `git -C docs add design/code_my_spec/sessions/design_review.md`

7. **Create Shell Command**: Build command using `Helpers.build_shell_command/2`
   - Pass `__MODULE__` as the step module
   - Pass the git command string
   - Returns `{:ok, Command.t()}`

### handle_result/4

1. **Handle Error Result**: If result status is `:error`
   - Update session status to `:failed`
   - Add `finalized_at` timestamp to session state
   - Return `{:ok, session_updates, result}`

2. **Handle Success Result**: If result status is `:ok`
   - Update session status to `:complete`
   - Add `finalized_at` timestamp to session state
   - Return `{:ok, session_updates, result}`

3. **Session Updates Map**: Build session updates containing:
   - `:status` - Set to `:complete` (success) or `:failed` (error)
   - `:state` - Merge existing state with new `finalized_at` timestamp

## Error Handling

- **Missing context component**: Return `{:error, "Context component not found in session"}` if session.component is nil
- **Git command failures**: Result status will be `:error`, handle_result marks session as `:failed`
- **Invalid file paths**: Return `{:error, "Invalid design file path"}` if path calculation fails
- **Missing review file**: Git add will fail if review file doesn't exist at expected path (ExecuteReview step responsibility)

## Dependencies

- Sessions (for session management and Command/Result types)
- Components (for component data access)
- Utils (for component_files/2 function)
- Helpers (for build_shell_command/2)
- Git CLI (for staging review file)

## Notes

- The Finalize step assumes the ExecuteReview step has successfully written the review file to the calculated path
- Git add command failures are captured in the result and cause the session to be marked as `:failed`
- Session status is updated to `:complete` on success to signal the end of the context review workflow
- The review file path must be relative to the "docs" working directory for git -C to work correctly
- Unlike some other Finalize steps that create pull requests, this step simply stages the review file - PR creation may be handled by a parent session or external process
- The finalized_at timestamp is added to session state for audit trail purposes
- This step does not broadcast any notifications - the Sessions context handles that automatically
